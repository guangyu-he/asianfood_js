<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>AFB Database</title>
    <link rel="shortcut icon" href="img/icon.png"/>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <style>
      nav ul{height: 100%;}
      nav ul{overflow:hidden; overflow-y:scroll;}
      li a {
        text-decoration: none;
        color: gray;
      }
      li a.visited {
        text-decoration: none;
      }
      li a.active {
        text-decoration: none;
      }
      ul {
        list-style-type: none;
        text-align: center;
        margin: 0;
        padding: 0;
        line-height: 300%;
      }
      #search_bar {
      width: 100%;
      background-repeat: no-repeat;
      font-size: 16px;
      padding: 20px 40px auto 40px;
      border: 1px solid #ddd;
      margin-bottom: 10px;
      border-radius: 2em;
      background:rgba(255, 255, 255, 0.9);
      text-align:center;
    }
    .navbar {
      overflow: hidden;
      background-color: #333;
      position: fixed;
      bottom: 0;
      height: 5%;
      width: 100%;
    }

    .title_bar{
      bottom: 0;
      height: 3.5%;
      left: 3%;
      position: fixed;
      cursor: pointer;
      z-index: 3;
      float: left;
      color: #f2f2f2;
      text-align: center;
      font-size: 17px;
    }
    </style>
  </head>
  <body onload="onload_function()">
    <input type="text" id="search_bar" onkeyup="search_function()" placeholder="Search for names.." title="Type in a name">
    <nav>
      <ul id="list">
        <li><a style="color: blue;">Add a restaurant</a></li>
      </ul>
    </nav>
    <div id="detail" style="width: auto; margin: auto; display: none;">
      <text>Name:</text><input type="text" id="name"><input type="button" id="name_btn" value="ok"><a target="_blank" id="name_link">Open in Google</a>
      <input type="text" placeholder="new lat,lng" id="name_latlng" style="display: none;"><input type="button" id="name_latlng_btn" value="ok" style="display: none;"><br>
      <text>Lat:</text><input type="text" id="lat"><br>
      <text>Lng:</text><input type="text" id="lng"><br>
      <text>Type:</text><input type="text" id="type"><br>
      <text>review:</text><input type="text" id="review"><br>
      <text>review_detail:</text><input type="text" id="review_detail">
    </div>
    <input type="button" value="save" id="save_btn" style="display: none;">
    <input type="button" value="delete" id="del_btn" style="color: red; display: none;">
    <input type="button" value="back" id="back_btn" style="display: none;">

    <div class="navbar">
    <a href="/" class="title_bar">Asia Food in Berlin</a><text id="version" style="color: chartreuse;"></text> </div>

  </body>

  <script>
    function load_database_locations(){
      var data_from_php = $.ajax(
        {
          url: 'return_locations.php',
          success: function (data) {},
          dataType: "text",
          async: false,
          error: function (err) {
              console.log(err);
          }
        }
      ).responseText;
      if( data_from_php == null || data_from_php == ""){
        return locations_builtin;
      }else{
        var location_list = data_from_php.split('<br>');
        var locations_out = [];
        for(var i=0;i<location_list.length - 1;i++){
          locations_out[i] = location_list[i].split(",");
          locations_out[i][1] = parseFloat(locations_out[i][1]);
          locations_out[i][2] = parseFloat(locations_out[i][2]);
        };
        return locations_out;
      }
   }

    function create_list_function(location_list){
      for(var i=0;i<location_list.length;i++){
        var li_ele = document.createElement('li');
        li_ele.setAttribute('id','list_'+i);
        var a_ele = document.createElement('a');
        a_ele.innerHTML = location_list[i][0];
        a_ele.href = "#";
        li_ele.appendChild(a_ele);
        li_ele.setAttribute("onmouseout","mouseout_function('list_"+i+"')");
        li_ele.setAttribute("onmouseover","mouseover_function('list_"+i+"')");
        document.getElementById("list").appendChild(li_ele);
      };
    }
    
    //list highlight
    function mouseover_function(id){
      document.getElementById(id).style = "border: solid 1px gray; border-radius: 2em";
    }
    function mouseout_function(id){
      document.getElementById(id).style = "border: solid 0px gray; border-radius: 2em";
    }

    //search bar control
    function search_function() {
      var input, filter, ul, li, a, i, txtValue;
      input = document.getElementById("search_bar");
      filter = input.value.toUpperCase();
      ul = document.getElementById("list");
      li = ul.getElementsByTagName("li");
      for (i = 0; i < li.length; i++) {
          a = li[i].getElementsByTagName("a")[0];
          txtValue = a.textContent || a.innerText;
          if (txtValue.toUpperCase().indexOf(filter) > -1) {
              li[i].style.display = "";
          } else {
              if(txtValue == "Add a restaurant"){
                li[i].style.display = "";
              }else{
                li[i].style.display = "none";
              }
          }
      }
    }

    //content div control
    function show_detail(index){      
      document.getElementById("list").style = "display:none";
      document.getElementById("search_bar").style = "display:none";
      document.getElementById("detail").style = "display:block";

      document.getElementById("name").value = locations[index][0];
      document.getElementById("lat").value = locations[index][1];
      document.getElementById("lng").value = locations[index][2];
      document.getElementById("type").value = locations[index][3];
      document.getElementById("review").value = locations[index][4];
      document.getElementById("review_detail").value = locations[index][5];

      document.getElementById("name_link").href = "http://maps.google.co.in/maps?q=" + document.getElementById("name").value;

      document.getElementById("name").addEventListener("change", function() {
        document.getElementById("name_link").href = "http://maps.google.co.in/maps?q=" + document.getElementById("name").value;
        document.getElementById("name_latlng").style = "display:block;";
        document.getElementById("name_latlng_btn").style = "display:block;";
        document.getElementById("name_btn").addEventListener("click", function() {
          locations[index][0] = document.getElementById("name").value;
        }, false);
      }, false);

      document.getElementById("name_latlng").addEventListener("change", function() {
        document.getElementById("name_latlng_btn").addEventListener("click", function() {
          locations[index][1] = document.getElementById("name_latlng").value.split(", ")[0];
          locations[index][2] = document.getElementById("name_latlng").value.split(", ")[1];
          document.getElementById("lat").value = locations[index][1];
          document.getElementById("lng").value = locations[index][2];
          document.getElementById("name_latlng").style = "display:none;";
          document.getElementById("name_latlng_btn").style = "display:none;";
        }, false); 
      }, false);

      document.getElementById("lat").addEventListener("change", function() {
          locations[index][1] = document.getElementById("lat").value;
      }, false);

      document.getElementById("lng").addEventListener("change", function() {
          locations[index][2] = document.getElementById("lng").value;
      }, false);

      document.getElementById("type").addEventListener("change", function() {
          locations[index][3] = document.getElementById("type").value;
      }, false);

      document.getElementById("review").addEventListener("change", function() {
          locations[index][4] = document.getElementById("review").value;
      }, false);

      document.getElementById("review_detail").addEventListener("change", function() {
          locations[index][5] = document.getElementById("review_detail").value;
      }, false);
      
      document.getElementById("back_btn").style = "display:inline";
      document.getElementById("back_btn").addEventListener("click", function() {
        main_list();
      }, false);
      document.getElementById("del_btn").style = "display:inline";
      document.getElementById("del_btn").addEventListener("click", function() {
        delete_function(locations[index][6]);
      }, false);
      document.getElementById("save_btn").style = "display:block"; 
      document.getElementById("save_btn").addEventListener("click", function() {
        for(var i=0;i<4;i++){
          if(locations[index][i] == null){
            alert("insufficient input");
            return false;
          }else{}
        }
        for(var i=4;i<6;i++){
          if(locations[index][i] == null){
            locations[index][i] = "";
          }else{}
        }
        save(locations[index][6],index);
      }, false);
    }

    function delete_function(id){
      var url_delete_location = "../delete_locations.php?id="+id;
      $.ajax({
        url: url_delete_location,
        success: function (data) {
          //console.log(data);
        },
        error: function (err) {
          console.log(err);
        }     
      });

      window.location.reload(true);
    }

    function save(id,i){
      var url_update_location = "../update_locations.php?n="+locations[i][0]+"&lat="+locations[i][1]+"&lng="+locations[i][2]+"&type="+locations[i][3]+"&r="+locations[i][4]+"&rd="+locations[i][5]+"&id="+locations[i][6];
      $.ajax({
        url: url_update_location,
        success: function (data) {
          //console.log(data);
        },
        error: function (err) {
          console.log(err);
        }     
      });

      versions_local.data_version = return_version_date();
      var url_update_version = "../update_versions.php?id="+versions_local.id+"&wv="+versions_local.web_version+"&dv="+versions_local.data_version;
      $.ajax({
        url: url_update_version,
        success: function (data) {
          //console.log(data);
        },
        error: function (err) {
          console.log(err);
        }     
      });

      window.location.reload(true);
    }
    function main_list(){
      document.getElementById("list").style = "display:block";
      document.getElementById("search_bar").style = "display:block";
      document.getElementById("detail").style = "display:none";
      document.getElementById("back_btn").style = "display:none";
      document.getElementById("save_btn").style = "display:none";
      document.getElementById("name_latlng").style = "display:none;";
      document.getElementById("name_latlng_btn").style = "display:none;";
    }

    //versions
    var versions_local = {
      id: "",
      web_version: 202110032206,
      data_version: 202110031630
    };
    function load_database_versions(){
      var data_from_php = $.ajax(
        {
          url: 'return_versions.php',
          success: function (data) {},
          dataType: "text",
          async: false,
          error: function (err) {
              console.log(err);
          }
        }
      ).responseText;
      var version_list = data_from_php.split('<br>');
      versions_local.data_version = parseInt(version_list[2]);
      versions_local.id = version_list[0];
      if(versions_local.web_version <= parseInt(version_list[1])){
        versions_local.web_version = parseInt(version_list[1]);
      }else{
      };

      document.getElementById("version").innerHTML = " Web Version:"+versions_local.web_version+" Data Version:"+versions_local.data_version;
    }

    function add_location(){
      document.getElementById("list").style = "display:none";
      document.getElementById("search_bar").style = "display:none";
      document.getElementById("detail").style = "display:block";

      document.getElementById("name").value = document.getElementById("search_bar").value;
      var upload_location_array = [];

      document.getElementById("name_btn").addEventListener("click", function() {
        document.getElementById("name_link").href = "http://maps.google.co.in/maps?q=" + document.getElementById("name").value;
        document.getElementById("name_latlng").style = "display:block;";
        document.getElementById("name_latlng_btn").style = "display:block;";
        upload_location_array[0] = document.getElementById("name").value;
      }, false);

      document.getElementById("name_latlng_btn").addEventListener("click", function() {
        upload_location_array[1] = document.getElementById("name_latlng").value.split(", ")[0];
        upload_location_array[2] = document.getElementById("name_latlng").value.split(", ")[1];
        document.getElementById("lat").value = upload_location_array[1];
        document.getElementById("lng").value = upload_location_array[2];
        document.getElementById("name_latlng").style = "display:none;";
        document.getElementById("name_latlng_btn").style = "display:none;";
      }, false); 

      document.getElementById("lat").addEventListener("change", function() {
          upload_location_array[1] = document.getElementById("lat").value;
      }, false);

      document.getElementById("lng").addEventListener("change", function() {
          upload_location_array[2] = document.getElementById("lng").value;
      }, false);

      document.getElementById("type").addEventListener("change", function() {
          upload_location_array[3] = document.getElementById("type").value;
      }, false);

      document.getElementById("review").addEventListener("change", function() {
          upload_location_array[4] = document.getElementById("review").value;
      }, false);

      document.getElementById("review_detail").addEventListener("change", function() {
          upload_location_array[5] = document.getElementById("review_detail").value;
      }, false);
      
      document.getElementById("back_btn").style = "display:inline";
      document.getElementById("back_btn").addEventListener("click", function() {
        main_list();
      }, false);
      document.getElementById("save_btn").style = "display:block"; 
      document.getElementById("save_btn").addEventListener("click", function() {
        for(var i=0;i<4;i++){
          if(upload_location_array[i] == null){
            alert("insufficient input");
            return false;
          }else{}
        }
        for(var i=4;i<6;i++){
          if(upload_location_array[i] == null){
            upload_location_array[i] = "";
          }else{}
        }
        //console.log(upload_location_array);
        upload_location(upload_location_array);
      }, false);
    }

    function upload_location(array){
      var url_upload_location = "../upload_locations.php?n="+array[0]+"&lat="+array[1]+"&lng="+array[2]+"&type="+array[3]+"&r="+array[4]+"&rd="+array[5];
      $.ajax({
        url: url_upload_location,
        success: function (data) {
          //console.log(data);
        },
        error: function (err) {
          console.log(err);
        }     
      });

      versions_local.data_version = return_version_date();
      var url_update_version = "../update_versions.php?id="+versions_local.id+"&wv="+versions_local.web_version+"&dv="+versions_local.data_version;
      $.ajax({
        url: url_update_version,
        success: function (data) {
          //console.log(data);
        },
        error: function (err) {
          console.log(err);
        }     
      });

      //window.location.reload(true);
    }

    function return_version_date(){
      var time = new Date();
      var year = String(time.getFullYear());
      var month_int = time.getMonth()+1;
      var month;
      if(month_int<10){
        month = "0" + String(month_int);
      }else{
        month = String(month_int);
      }
      var day_int = time.getDate();
      var day;
      if(day_int<10){
        day = "0" + String(day_int);
      }else{
        day = String(day_int);
      }
      var hour_int = time.getHours();
      var hour;
      if(hour_int<10){
        hour = "0" + String(hour_int);
      }else{
        hour = String(hour_int);
      }
      var min_int = time.getMinutes();
      var min;
      if(min_int<10){
        min = "0" + String(min_int);
      }else{
        min = String(min_int);
      }
      return year+month+day+hour+min;
    }

    var locations;
    function onload_function(){
      //loading data from server
      locations = load_database_locations();
      create_list_function(locations);
      load_database_versions();


      let ul = document.getElementsByTagName('ul')[0];
      ul.onclick = function(e){
          if (e.target != ul) {
              for(var i=0;i<locations.length;i++){
                  if(locations[i][0] == e.target.innerText){
                    show_detail(i);
                  }else if(e.target.innerText == "Add a restaurant"){
                    add_location();
                  }
                  else{};
              }
          }
      }

    }
  </script>
</html>



